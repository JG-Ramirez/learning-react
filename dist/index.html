<html>

<head>
    <title>bullet journal</title>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <div id="container"></div>
    <script>
        /* TODO: clean up this */
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        if ('serviceWorker' in navigator) {

            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js').then(function (ServiceWorkerRegistration) {
                    // Registration was successful
                    console.log('ServiceWorker registration successful with scope: ', ServiceWorkerRegistration.scope);
                    const subscribeOptions = {
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array('BNVFaEer_S5bnKoFlwJjf5wzW7EUCIWzYtu6wVw_mnwWVCukMNdwyC1grHaQSfVEeDIFohbgw47tncBHaNa9AZE')
                    };
                    return ServiceWorkerRegistration.pushManager.subscribe(subscribeOptions);
                }).then(function (pushSubscription) {
                    console.log(`this is the endpoint of this user ${PushSubscription.endpoint}`)
                    return fetch(`/api/save-subscription`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(PushSubscription)
                    })
                }).catch(function (err) {
                    // registration failed :(
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script src="/bundle.js">

    </script>
</body>

</html>